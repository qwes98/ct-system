# System Architecture

코딩테스트 연습 플랫폼의 전체 시스템 아키텍처 문서입니다.

## 1. 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client (Browser)                                │
│                         Next.js + shadcn/ui + Monaco                        │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │ HTTPS
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API Gateway / Load Balancer                        │
│                              (Nginx / AWS ALB)                               │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Backend API (Spring Boot)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Problem    │  │    Run      │  │   Submit    │  │  History    │        │
│  │  Service    │  │   Service   │  │   Service   │  │  Service    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└────────┬────────────────┬────────────────┬────────────────┬─────────────────┘
         │                │                │                │
         ▼                ▼                ▼                ▼
┌─────────────┐    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ PostgreSQL  │    │   Judge0    │  │    Redis    │  │    Redis    │
│   (Data)    │    │  (Execute)  │  │   (Queue)   │  │   (Cache)   │
└─────────────┘    └─────────────┘  └─────────────┘  └─────────────┘
```

## 2. 컴포넌트 상세

### 2.1 Frontend (Next.js)

| 항목 | 설명 |
|------|------|
| Framework | Next.js 14+ (App Router) |
| UI Library | shadcn/ui (Radix UI 기반) |
| Code Editor | Monaco Editor |
| State Management | React Context / Zustand / React Query |
| HTTP Client | Axios / Fetch API |

**주요 페이지:**
- `/` - 문제 리스트
- `/problems/[id]` - 문제 풀이 페이지 (에디터 + 결과)
- `/submissions` - 제출 이력

### 2.2 Backend API (Spring Boot)

| 항목 | 설명 |
|------|------|
| Framework | Spring Boot 3.x |
| Language | Java 17+ |
| Build Tool | Gradle |
| API Style | REST API |
| Documentation | SpringDoc OpenAPI (Swagger) |

**핵심 서비스:**

```
├── ProblemService        # 문제 CRUD, 템플릿 제공
├── RunService            # 샘플 테스트 실행 (동기)
├── SubmitService         # 전체 테스트 제출 (비동기)
├── ExecutionService      # Judge0 연동
├── SubmissionService     # 제출 이력 관리
└── GuestSessionService   # 게스트 토큰 관리
```

### 2.3 Execution Engine (Judge0)

| 항목 | 설명 |
|------|------|
| Deployment | Self-hosted (Docker) |
| Languages | Python, Java, C++, JavaScript |
| Isolation | Container-based (isolate) |
| API Version | Judge0 CE v1.13.0+ |

**리소스 제한 (기본값):**
- CPU: 1 vCPU
- Memory: 512MB
- Time Limit: 2-5초 (문제별 설정)
- Network: 완전 차단

### 2.4 Database (PostgreSQL)

| 항목 | 설명 |
|------|------|
| Version | PostgreSQL 15+ |
| Connection Pool | HikariCP |
| Migration | Flyway |

### 2.5 Message Queue (Redis)

| 항목 | 설명 |
|------|------|
| Version | Redis 7+ |
| Purpose | Submit 비동기 큐, 캐시 |
| Client | Lettuce (Spring Data Redis) |

## 3. 핵심 플로우

### 3.1 Run (샘플 테스트 실행)

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
│Client│────▶│ Backend  │────▶│  Judge0  │────▶│ Response│
└──────┘     └──────────┘     └──────────┘     └─────────┘
   │              │                 │               │
   │  POST /run   │                 │               │
   │─────────────▶│                 │               │
   │              │  Submit code    │               │
   │              │────────────────▶│               │
   │              │                 │  Execute      │
   │              │                 │  (sync)       │
   │              │  Result         │               │
   │              │◀────────────────│               │
   │  200 OK      │                 │               │
   │◀─────────────│                 │               │
```

**특징:**
- 동기 처리 (즉시 응답)
- 샘플 테스트케이스만 실행
- 동시 처리: 50 concurrent

### 3.2 Submit (전체 테스트 제출)

```
┌──────┐     ┌──────────┐     ┌───────┐     ┌────────┐     ┌─────────┐
│Client│────▶│ Backend  │────▶│ Redis │────▶│ Worker │────▶│ Judge0  │
└──────┘     └──────────┘     └───────┘     └────────┘     └─────────┘
   │              │               │              │              │
   │ POST /submit │               │              │              │
   │─────────────▶│               │              │              │
   │              │ Enqueue       │              │              │
   │              │──────────────▶│              │              │
   │ 202 Accepted │               │              │              │
   │◀─────────────│               │              │              │
   │              │               │  Dequeue     │              │
   │              │               │─────────────▶│              │
   │              │               │              │  Execute     │
   │              │               │              │─────────────▶│
   │              │               │              │  Result      │
   │              │               │              │◀─────────────│
   │              │ Update Status │              │              │
   │              │◀──────────────────────────────│              │
   │              │               │              │              │
   │ GET /submissions/{id}        │              │              │
   │─────────────▶│               │              │              │
   │ 200 OK       │               │              │              │
   │◀─────────────│               │              │              │
```

**특징:**
- 비동기 처리 (큐 기반)
- 전체 테스트케이스 실행 (샘플 + 숨김)
- 상태 머신: `queued` → `running` → `done`
- 동시 처리: 20 concurrent (워커 확장 가능)

### 3.3 제출 상태 조회 (Polling)

```
Client                    Backend                   Database
   │                         │                          │
   │  GET /submissions/{id}  │                          │
   │────────────────────────▶│                          │
   │                         │  SELECT status           │
   │                         │─────────────────────────▶│
   │                         │  status = 'running'      │
   │                         │◀─────────────────────────│
   │  { status: "running" }  │                          │
   │◀────────────────────────│                          │
   │                         │                          │
   │  (2초 후 재요청)          │                          │
   │────────────────────────▶│                          │
   │                         │─────────────────────────▶│
   │                         │  status = 'done'         │
   │                         │◀─────────────────────────│
   │  { status: "done", ... }│                          │
   │◀────────────────────────│                          │
```

## 4. 동시성 & 확장성

### 4.1 동시 처리 목표

| 작업 | 목표 동시성 | 처리 방식 |
|------|-------------|-----------|
| Run | 50 concurrent | 동기 (Judge0 직접 호출) |
| Submit | 20 concurrent | 비동기 (Redis Queue + Worker) |

### 4.2 확장 전략

```
                    ┌─────────────┐
                    │Load Balancer│
                    └──────┬──────┘
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │ API Server │  │ API Server │  │ API Server │
    │     #1     │  │     #2     │  │     #3     │
    └────────────┘  └────────────┘  └────────────┘
           │               │               │
           └───────────────┼───────────────┘
                           ▼
                    ┌─────────────┐
                    │ Redis Queue │
                    └──────┬──────┘
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │   Worker   │  │   Worker   │  │   Worker   │
    │     #1     │  │     #2     │  │     #3     │
    └────────────┘  └────────────┘  └────────────┘
           │               │               │
           └───────────────┼───────────────┘
                           ▼
                    ┌─────────────┐
                    │   Judge0    │
                    │   Cluster   │
                    └─────────────┘
```

**수평 확장 포인트:**
1. API Server: Stateless → LB 뒤에서 무한 확장
2. Worker: Redis 큐 기반 → 워커 수 증가로 처리량 확장
3. Judge0: 여러 인스턴스 운영 가능

## 5. 보안 아키텍처

### 5.1 네트워크 보안

```
┌─────────────────────────────────────────────────────────────┐
│                        Public Zone                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Load Balancer (HTTPS only)              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ Internal Network
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Private Zone                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ API Server  │  │    Redis    │  │ PostgreSQL  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ Isolated Network
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Execution Zone                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Judge0 (No outbound network, resource limited)     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 애플리케이션 보안

| 계층 | 보안 조치 |
|------|-----------|
| API | Rate limiting (IP/세션 기준) |
| Input | 코드 크기 제한, 입력값 검증 |
| Execution | 컨테이너 격리, 리소스 제한, 네트워크 차단 |
| Data | 숨김 테스트케이스 비공개, 상세 로그 미노출 |

## 6. 모니터링 & 로깅

### 6.1 메트릭 수집

| 메트릭 | 도구 | 목적 |
|--------|------|------|
| API Latency | Micrometer + Prometheus | P95 응답시간 모니터링 |
| Queue Depth | Redis INFO | Submit 적체 감지 |
| Judge0 Status | Health Check | 실행 엔진 상태 |
| Error Rate | Application Logs | 장애 탐지 |

### 6.2 핵심 SLI/SLO

| SLI | SLO | 측정 방법 |
|-----|-----|-----------|
| Submit 응답 시간 | P95 < 10초 | 제출 → done 상태까지 |
| 제출 완료율 | 90%+ | 성공 제출 / 전체 제출 |
| API 가용성 | 99.5% | Uptime 모니터링 |

## 7. 기술 부채 & 향후 고려사항

### MVP에서 제외 (로드맵)

| 항목 | 이유 | 향후 계획 |
|------|------|-----------|
| WebSocket | Polling으로 충분 | 실시간 피드백 필요시 도입 |
| gVisor/Firecracker | 교육용 MVP | 채용 플랫폼 확장시 검토 |
| 분산 캐시 | 단일 Redis로 충분 | 트래픽 증가시 Redis Cluster |
| 사용자 인증 | 게스트 only MVP | OAuth/JWT 추가 예정 |
